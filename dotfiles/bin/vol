#!/usr/bin/env sh

. "$DOTFILES_DIR/lib/core.sh"

vol_usage() {

cat <<EOF
vol is a wrapper for pactl/pacmd

Usage: vol [integer/option]"

    [0-150] - set volume percentage"
    up      - increase volume by \`argument'"
    down    - decrease volume by \`argument'"
    mute    - toggle mute on and off"
    --help  - display this message"

EOF

}

active_sound_card() {

  local activeSoundCard

  activeSoundCard=$(\
    pactl list sinks | \
    grep --before-context=1 "State: RUNNING" | \
    awk -F'[^0-9]*' '/Sink\ \#/ { print $2 ; exit }')

  # If no active sound card is found fallback to the default
  [ -z "$activeSoundCard" ] && {
    activeSoundCard=$(\
      pacmd list-sinks | \
      grep -m 1 "* index: " | \
      grep -o '[0-9]*')
  }

  [ -z "$activeSoundCard" ] && { echo "ERROR: failed to obtain sound card" ; return 1 ; }

  echo "$activeSoundCard"

  return 0

}

volume_current() {

  pactl list sinks | \
    grep --after-context=9 "Sink #$(active_sound_card)" | \
    grep "Volume:" | \
    awk '/[^0-9]*\%/ { print $5 ; exit }'

}

vol() {

  # If 'pactl' is not installed, be done now
  path_hasbin pactl || return 1

  # Parse Arguments
  case "$1" in
    '')
      echo "Volume: $(volume_current)"
      ;;
    [U,u]|[U,u][P,p])
      pactl set-sink-volume $(active_sound_card) -- "+5%"
      ;;
    [D,d]|[D,d][O,o][W,w][N,n])
      pactl set-sink-volume $(active_sound_card) -- "-5%"
      ;;
    [M,m]|[M,m][U,u][T,t][E,e])
      pactl set-sink-mute $(active_sound_card) toggle
      ;;
    [L,l]|[L,l][I,i][S,s][T,t])
      pactl list sinks | grep "Sink #\|alsa.mixer_name"
      ;;
    '--help')
      vol_usage
      return 0
      ;;
    *)
      case $1 in
        [0-9]|[1-9][0-9]|1[0-4][0-9]|150)
          pactl set-sink-volume $(active_sound_card) -- "${1}%"
          ;;
        *)
          echo -e "$(termclr red 0)ERROR: must be an integer between 0 and 150$(termclr reset 0)"
          vol_usage
          return 1
          ;;
      esac
      ;;
  esac

}
