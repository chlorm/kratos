#!/usr/bin/env sh

export DOTFILES_DIR="$(readlink -f "$(dirname "$(readlink -f "$0")")")"

cd "$DOTFILES_DIR"

mkdir -p "$HOME/.local/share/dotfiles"
echo "$DOTFILES_DIR" > "$HOME/.local/share/dotfiles/dotfiles.dir"

if [ ! -f "$HOME/.local/share/dotfiles/settings.local" ] ; then
  touch "$HOME/.local/share/dotfiles/settings.local"
  echo '#!/usr/bin/env sh' >> "$HOME/.local/share/dotfiles/settings.local"
fi

# Load configuration settings
. "$DOTFILES_DIR/settings"
. "$DOTFILES_DIR/settings.local"

. lib/loader || exit 128

if [ -z "$dotfilesRepo" ] ; then
  echo "ERROR: dotfiles remote repo origin is not set"
  exit 1
fi

git remote set-url origin "$dotfilesRepo"
git remote set-url --push origin "$dotfilesRepo"

echo "Updating Config Files"
dotfiles_latest || { echo "Failed to update Configs" ; exit 1 ; }

dotfiles_install || { echo "ERROR: configuration install failed" ; exit 1 ; }
